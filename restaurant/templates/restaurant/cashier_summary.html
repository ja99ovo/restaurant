{% extends "restaurant/base.html" %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/pay.css' %}">

<div class="sales-dashboard">
    <h2>订单结算</h2>

    <div class="summary-panel">
        <div class="summary-box">
            <div>Total des commandes</div>
            <div>{{ total_orders }}</div>
        </div>
        <div class="summary-box">
            <div>Commandes acceptées</div>
            <div>{{ accepted_orders }}</div>
        </div>
    </div>
    

    <table class="orders-table">
      <thead>
          <tr>
              <th>订单号</th>
              <th>时间</th>
              <th>桌号</th>
              <th>成人</th>
              <th>小孩</th>
              <th>幼儿</th>
              <th>饮品详情</th>
              <th>总价</th>
          </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
            <td>{{ order.id }}</td>
            <td>{{ order.updated_at|date:"d M Y à H:i" }}</td>
            <td>{{ order.table.name }}</td>
            <td>{{ order.adults }}</td>
            <td>{{ order.kids }}</td>
            <td>{{ order.toddlers }}</td>
            <td>
                {% for item in order.order_item_set.all %}
                {{ item.boisson.name }} x {{ item.quantity }}<br>
                {% endfor %}
            </td>
            <td>{{ order.total_price }}</td>
            <td>
              {% if order.user %}
                  {{ order.user.username }}
              {% else %}
                  Anonymous
              {% endif %}
            </td>
        </tr>
        {% endfor %}
    
      </tbody>
  </table>
</div>

<script>
  setInterval(function() {
      fetch("{% url 'cashier_summary' %}", {
          headers: {
              'X-Requested-With': 'XMLHttpRequest'  // 确保 Django 能识别这是 AJAX 请求
          }
      })
      .then(response => response.json())
      .then(orders => {
          let tableBody = document.querySelector('.orders-table tbody');
          let newHtml = '';
          orders.forEach(order => {
              newHtml += `<tr>
                  <td>${order.id}</td>
                  <td>${order.updated_at}</td>
                  <td>${order.table}</td>
                  <td>${order.adults}</td>
                  <td>${order.kids}</td>
                  <td>${order.toddlers}</td>
                  <td>${order.items.map(item => `${item.name} x ${item.quantity}`).join('<br>')}</td>
                  <td>${order.total_price.toFixed(2)}</td>
                  <td>${order.username}</td>
              </tr>`;
          });
          tableBody.innerHTML = newHtml; // 只更新表格体
      });
  }, 30000);  // 每30秒更新一次
</script>

{% endblock %}
